<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Authorization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .telegram-widget-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            display: none;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            display: block;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }

        .status.loading {
            background: #e3f2fd;
            color: #1565c0;
            display: block;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }

        .loader.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            font-size: 12px;
            color: #666;
            text-align: left;
        }

        .info strong {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h1>
        <p class="subtitle">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>

        <div class="telegram-widget-container">
            <script async src="https://telegram.org/js/telegram-widget.js?22"
                data-telegram-login="agurevAuthBot"
                data-size="large"
                data-radius="10"
                data-onauth="onTelegramAuth(user)"
                data-request-access="write">
            </script>
        </div>

        <div id="status" class="status"></div>
        <div id="loader" class="loader"></div>

        <div class="info">
            <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong><br>
            1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É Telegram<br>
            2. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é<br>
            3. –í—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω–µ—Ç–µ—Å—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        </div>
    </div>

    <script>
        // –ü–æ–ª—É—á–∞–µ–º custom URI scheme –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        const customScheme = urlParams.get('scheme') || 'myunityapp';
        const deepLinkHost = urlParams.get('host') || 'telegram_auth';

        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }

        function showLoader(show) {
            const loaderEl = document.getElementById('loader');
            loaderEl.className = show ? 'loader active' : 'loader';
        }

        // Callback —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è Telegram Widget
        function onTelegramAuth(user) {
            console.log('Telegram auth successful:', user);
            
            showStatus('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...', 'success');
            showLoader(true);

            // –§–æ—Ä–º–∏—Ä—É–µ–º Deep Link URL —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const deepLinkUrl = `${customScheme}://${deepLinkHost}?` +
                `user_id=${user.id}` +
                `&first_name=${encodeURIComponent(user.first_name || '')}` +
                `&last_name=${encodeURIComponent(user.last_name || '')}` +
                `&username=${encodeURIComponent(user.username || '')}` +
                `&photo_url=${encodeURIComponent(user.photo_url || '')}` +
                `&auth_date=${user.auth_date}` +
                `&hash=${user.hash}`;

            console.log('Redirecting to:', deepLinkUrl);

            // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å Deep Link –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
            setTimeout(() => {
                try {
                    // –ú–µ—Ç–æ–¥ 1: –ü–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ invisible iframe (—Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö)
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = deepLinkUrl;
                    document.body.appendChild(iframe);

                    // –ú–µ—Ç–æ–¥ 2: Fallback —á–µ—Ä–µ–∑ window.location
                    setTimeout(() => {
                        window.location.href = deepLinkUrl;
                    }, 25);

                    // –ú–µ—Ç–æ–¥ 3: –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ
                    setTimeout(() => {
                        showStatus('‚ö†Ô∏è –ù–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?', 'error');
                        showLoader(false);
                        
                        const statusEl = document.getElementById('status');
                        const button = document.createElement('button');
                        button.textContent = 'üì± –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é';
                        button.style.cssText = 'margin-top:15px;padding:12px 24px;background:#0088cc;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;';
                        button.onclick = () => {
                            window.location.href = deepLinkUrl;
                        };
                        statusEl.parentElement.appendChild(button);
                    }, 2500);
                } catch (error) {
                    console.error('Failed to redirect:', error);
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', 'error');
                    showLoader(false);
                }
            }, 500);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (event) => {
            console.error('Error:', event.error);
            showStatus('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        console.log('Telegram Auth Middleware loaded');
        console.log('Custom scheme:', customScheme);
        console.log('Deep link host:', deepLinkHost);
    </script>
</body>
</html>

